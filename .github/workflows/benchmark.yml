name: Benchmark

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install dependencies for GMP (rug crate)
      run: |
        sudo apt-get update
        sudo apt-get install -y libgmp-dev
        
    - name: Install cargo-criterion
      run: cargo install cargo-criterion
        
    - name: Create benchmark results directory
      run: mkdir -p benchmark-results
      
    - name: Run benchmarks with JSON output
      run: cargo criterion --message-format=json > benchmark-results/benchmark_results.json
      
    - name: Generate markdown table
      run: |
        python3 scripts/json_to_markdown.py benchmark-results/benchmark_results.json > BENCHMARK_RESULTS.md
        
    - name: Update README with benchmark results
      if: github.ref == 'refs/heads/master'
      run: |
        # Create a marker for benchmark results section
        sed -i '/<!-- BENCHMARK_RESULTS_START -->/,/<!-- BENCHMARK_RESULTS_END -->/d' README.md
        echo "<!-- BENCHMARK_RESULTS_START -->" >> README.md
        cat BENCHMARK_RESULTS.md >> README.md
        echo "<!-- BENCHMARK_RESULTS_END -->" >> README.md
        
    - name: Commit benchmark results
      if: github.ref == 'refs/heads/master'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md BENCHMARK_RESULTS.md
        git diff --staged --quiet || git commit -m "Update benchmark results ðŸš€"
        git push